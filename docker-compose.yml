services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        EXTRAS: "kafka,causal"
    environment:
      CARF_TEST_MODE: "1"
      LLM_PROVIDER: "deepseek"
      CARF_DATA_DIR: "/app/var"
      NEO4J_URI: "bolt://neo4j:7687"
      NEO4J_USERNAME: "neo4j"
      NEO4J_PASSWORD: "carf_password"
      NEO4J_DATABASE: "neo4j"
      KAFKA_ENABLED: "true"
      KAFKA_BOOTSTRAP_SERVERS: "kafka:9092"
      KAFKA_TOPIC: "carf_decisions"
      KAFKA_CLIENT_ID: "carf"
      OPA_ENABLED: "false"
      OPA_URL: "http://opa:8181"
      OPA_POLICY_PATH: "/v1/data/carf/guardian/allow"
      OPA_TIMEOUT_SECONDS: "5"
    ports:
      - "8000:8000"
    volumes:
      - ./var:/app/var
    depends_on:
      neo4j:
        condition: service_healthy
      kafka:
        condition: service_healthy
      opa:
        condition: service_started
      zookeeper:
        condition: service_started

  cockpit:
    build:
      context: ./carf-cockpit
      dockerfile: Dockerfile
    ports:
      - "5176:5175"
    depends_on:
      - app

  seed:
    profiles: ["demo"]
    build:
      context: .
      dockerfile: Dockerfile
      args:
        EXTRAS: "kafka,causal"
    environment:
      CARF_TEST_MODE: "1"
      CARF_DATA_DIR: "/app/var"
      NEO4J_URI: "bolt://neo4j:7687"
      NEO4J_USERNAME: "neo4j"
      NEO4J_PASSWORD: "carf_password"
      NEO4J_DATABASE: "neo4j"
      KAFKA_ENABLED: "true"
      KAFKA_BOOTSTRAP_SERVERS: "kafka:9092"
      KAFKA_TOPIC: "carf_decisions"
      KAFKA_CLIENT_ID: "carf"
    command: ["bash", "-lc", "python scripts/seed_demo.py && python scripts/publish_demo_event.py"]
    volumes:
      - ./var:/app/var
    depends_on:
      neo4j:
        condition: service_healthy
      kafka:
        condition: service_healthy

  neo4j:
    image: neo4j:5
    environment:
      NEO4J_AUTH: "neo4j/carf_password"
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - neo4j_data:/data
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "neo4j", "-p", "carf_password", "RETURN 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.3
    environment:
      ZOOKEEPER_CLIENT_PORT: "2181"
      ZOOKEEPER_TICK_TIME: "2000"
    ports:
      - "2181:2181"

  kafka:
    image: confluentinc/cp-kafka:7.5.3
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: "1"
      KAFKA_ZOOKEEPER_CONNECT: "zookeeper:2181"
      KAFKA_LISTENERS: "PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:29092"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092"
      KAFKA_INTER_BROKER_LISTENER_NAME: "PLAINTEXT"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: "1"
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: "1"
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: "1"
    ports:
      - "9092:9092"
      - "39092:29092"
    healthcheck:
      test: ["CMD", "bash", "-c", "kafka-broker-api-versions --bootstrap-server localhost:9092"]
      interval: 10s
      timeout: 5s
      retries: 10

  opa:
    image: openpolicyagent/opa:0.63.0
    command:
      - "run"
      - "--server"
      - "--set=decision_logs.console=true"
      - "--addr=0.0.0.0:8181"
      - "/policies/guardian.rego"
    volumes:
      - ./config/opa/guardian.rego:/policies/guardian.rego:ro
    ports:
      - "8181:8181"

volumes:
  neo4j_data:
